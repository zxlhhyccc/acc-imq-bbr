#!/bin/sh /etc/rc.common

START=99

enable_affinity_ipq807x(){
	set_affinity() {
		irq=$(awk "/$1/{ print substr(\$1, 1, length(\$1)-1); exit }" /proc/interrupts)
		[ -n "$irq" ] && echo $2 > /proc/irq/$irq/smp_affinity
	}

	# assign 4 rx interrupts to each core
	set_affinity 'reo2host-destination-ring1' 1
	set_affinity 'reo2host-destination-ring2' 2
	set_affinity 'reo2host-destination-ring3' 4
	set_affinity 'reo2host-destination-ring4' 8

	# assign 3 tcl completions to last 3 CPUs
	set_affinity 'wbm2host-tx-completions-ring1' 2
	set_affinity 'wbm2host-tx-completions-ring2' 4
	set_affinity 'wbm2host-tx-completions-ring3' 8

	# LAN
	for q in $(ls /sys/class/net/lan*/queues/rx-*/rps_cpus); do echo f > $q; done
	for q in $(ls /sys/class/net/lan*/queues/tx-*/xps_cpus); do echo f > $q; done
	for q in $(ls /sys/class/net/lan*/queues/rx-*/rps_flow_cnt); do echo 4096 > $q; done
	# WAN
	for q in $(ls /sys/class/net/wan/queues/rx-*/rps_cpus); do echo f > $q; done
	for q in $(ls /sys/class/net/wan/queues/tx-*/xps_cpus); do echo f > $q; done
	for q in $(ls /sys/class/net/wan/queues/rx-*/rps_flow_cnt); do echo 4096 > $q; done

	echo 32768 > /proc/sys/net/core/rps_sock_flow_entries
}

boot() {
	case $(board_name) in
	dynalink,dl-wrx36|\
	edgecore,eap102|\
	edimax,cax1800|\
	qnap,301w|\
	redmi,ax6|\
	xiaomi,ax3600|\
	xiaomi,ax9000)
		enable_affinity_ipq807x
	;;
	esac
}
